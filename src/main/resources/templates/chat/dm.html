<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DM - YAMABIKO</title>
    <link rel="icon" th:href="@{/img/common/favicon.ico}" href="../static/img/common/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/style.css}" href="../static/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="chat-page">
    <div class="slack-container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="slack-sidebar">
            <div class="slack-sidebar-header">
                <div class="slack-workspace-icon">Y</div>
                <div class="slack-workspace-name">YAMABIKO</div>
            </div>
            <div class="slack-sidebar-nav">
                <a href="#" th:href="@{/chat}" class="slack-nav-item">
                    <span class="slack-nav-icon">ğŸ </span>
                    <span>ãƒ›ãƒ¼ãƒ </span>
                </a>
                <a href="#" th:href="@{/chat/dm}" class="slack-nav-item active">
                    <span class="slack-nav-icon">ğŸ’¬</span>
                    <span>DM</span>
                </a>
                <a href="#" th:href="@{/chat/activity}" class="slack-nav-item">
                    <span class="slack-nav-icon">ğŸ””</span>
                    <span>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</span>
                </a>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="slack-main">
            <div class="slack-top-header">
                <div class="slack-header-left">
                    <div class="slack-header-channel-name">ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                </div>
            </div>
            
            <div class="slack-messages dm-empty-state">
                <div class="dm-empty-state-card">
                    <h2 class="dm-empty-state-title">ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
                    <p class="dm-empty-state-description">
                        ä¼šè©±ã‚’é–‹å§‹ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸã•ã‚Œã¾ã™ã€‚
                    </p>

                    <div th:if="${partners != null && !partners.isEmpty()}" class="dm-user-section">
                        <h3>æœ€è¿‘ã®ä¼šè©±</h3>
                        <ul class="dm-user-list">
                            <li th:each="partner : ${partners}">
                                <a th:href="@{/chat/dm/{id}(id=${partner})}" class="dm-user-link">
                                    <div class="dm-user-primary">
                                        <span class="dm-user-name" th:text="${partner}">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</span>
                                        <span class="dm-user-meta">æœ€è¿‘ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸä¼šè©±</span>
                                    </div>
                                    <span class="dm-user-chevron">â€º</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div th:if="${allUsers != null && !allUsers.isEmpty()}" class="dm-user-section">
                        <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ä¼šè©±ã‚’é–‹å§‹</h3>
                        <ul class="dm-user-list">
                            <li th:each="user : ${allUsers}">
                                <a th:href="@{/chat/dm/{id}(id=${user.userId()})}" class="dm-user-link">
                                    <div class="dm-user-primary">
                                        <span class="dm-user-name" th:text="${user.userName() != null ? user.userName() : user.userId()}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                                        <span th:if="${user.role() == 'ROLE_TEACHER'}" class="dm-user-meta">è¬›å¸«</span>
                                        <span th:if="${user.role() == 'ROLE_ADMIN'}" class="dm-user-meta">ç®¡ç†è€…</span>
                                    </div>
                                    <span class="dm-user-chevron">â€º</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div th:if="${allUsers == null || allUsers.isEmpty()}" class="dm-empty-feedback">
                        ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const userId = /*[[${userId}]]*/ '';
        
        // WebSocketæ¥ç¶šã‚’ç¢ºç«‹
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        
        // WebSocketæ¥ç¶šã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®è³¼èª­
        stompClient.connect({}, function(frame) {
            console.log('STOMP Connected: ' + frame);
            
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
            stompClient.subscribe('/topic/users.activity', function(message) {
                const newUser = JSON.parse(message.body);
                handleNewUserRegistration(newUser);
            });
            
            console.log('Subscribed to: /topic/users.activity');
        }, function(error) {
            console.error('STOMP connection error: ', error);
        });
        
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
        function handleNewUserRegistration(newUser) {
            if (!newUser || !newUser.userId) {
                return;
            }
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã¯é™¤å¤–
            if (newUser.userId === userId) {
                return;
            }
            
            // æ—¢ã«ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingLink = document.querySelector('a[href="/chat/dm/' + newUser.userId + '"]');
            if (existingLink) {
                // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯æ›´æ–°ã—ãªã„
                return;
            }
            
            // ç©ºã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            const emptyFeedback = document.querySelector('.dm-empty-feedback');
            if (emptyFeedback) {
                emptyFeedback.style.display = 'none';
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
            let userSection = document.querySelector('.dm-user-section:last-of-type');
            if (!userSection) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                const emptyStateCard = document.querySelector('.dm-empty-state-card');
                if (emptyStateCard) {
                    userSection = document.createElement('div');
                    userSection.className = 'dm-user-section';
                    userSection.innerHTML = '<h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ä¼šè©±ã‚’é–‹å§‹</h3><ul class="dm-user-list"></ul>';
                    emptyStateCard.appendChild(userSection);
                } else {
                    return; // ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯çµ‚äº†
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
            const userList = userSection.querySelector('.dm-user-list');
            if (!userList) {
                return;
            }
            
            // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            const userName = newUser.userName || newUser.userId;
            const role = newUser.role;
            let roleBadge = '';
            if (role === 'ROLE_TEACHER') {
                roleBadge = '<span class="dm-user-meta">è¬›å¸«</span>';
            } else if (role === 'ROLE_ADMIN') {
                roleBadge = '<span class="dm-user-meta">ç®¡ç†è€…</span>';
            }
            
            const newUserItem = document.createElement('li');
            newUserItem.innerHTML = 
                '<a href="/chat/dm/' + newUser.userId + '" class="dm-user-link">' +
                '<div class="dm-user-primary">' +
                '<span class="dm-user-name">' + escapeHtml(userName) + '</span>' +
                roleBadge +
                '</div>' +
                '<span class="dm-user-chevron">â€º</span>' +
                '</a>';
            
            userList.appendChild(newUserItem);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            newUserItem.style.opacity = '0';
            setTimeout(() => {
                newUserItem.style.transition = 'opacity 0.3s';
                newUserItem.style.opacity = '1';
            }, 10);
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å®šæœŸçš„ã«æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ®‹ã™
        function refreshUserList() {
            fetch('/chat/users')
                .then(response => response.json())
                .then(users => {
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
                    const otherUsers = users.filter(u => u.userId !== userId);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                    const userSection = document.querySelector('.dm-user-section:last-of-type');
                    const emptyFeedback = document.querySelector('.dm-empty-feedback');
                    
                    if (otherUsers.length > 0) {
                        // ç©ºã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éè¡¨ç¤º
                        if (emptyFeedback) {
                            emptyFeedback.style.display = 'none';
                        }
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                        if (userSection) {
                            const userList = userSection.querySelector('.dm-user-list');
                            if (userList) {
                                userList.innerHTML = otherUsers.map(user => {
                                    const userName = user.userName || user.userId;
                                    const role = user.role;
                                    let roleBadge = '';
                                    if (role === 'ROLE_TEACHER') {
                                        roleBadge = '<span class="dm-user-meta">è¬›å¸«</span>';
                                    } else if (role === 'ROLE_ADMIN') {
                                        roleBadge = '<span class="dm-user-meta">ç®¡ç†è€…</span>';
                                    }
                                    
                                    return '<li>' +
                                        '<a href="/chat/dm/' + user.userId + '" class="dm-user-link">' +
                                        '<div class="dm-user-primary">' +
                                        '<span class="dm-user-name">' + escapeHtml(userName) + '</span>' +
                                        roleBadge +
                                        '</div>' +
                                        '<span class="dm-user-chevron">â€º</span>' +
                                        '</a>' +
                                        '</li>';
                                }).join('');
                            }
                        } else {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                            const emptyStateCard = document.querySelector('.dm-empty-state-card');
                            if (emptyStateCard) {
                                // æ—¢å­˜ã®ç©ºã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤
                                if (emptyFeedback) {
                                    emptyFeedback.remove();
                                }
                                
                                const newSection = document.createElement('div');
                                newSection.className = 'dm-user-section';
                                newSection.innerHTML = 
                                    '<h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ä¼šè©±ã‚’é–‹å§‹</h3>' +
                                    '<ul class="dm-user-list">' +
                                    otherUsers.map(user => {
                                        const userName = user.userName || user.userId;
                                        const role = user.role;
                                        let roleBadge = '';
                                        if (role === 'ROLE_TEACHER') {
                                            roleBadge = '<span class="dm-user-meta">è¬›å¸«</span>';
                                        } else if (role === 'ROLE_ADMIN') {
                                            roleBadge = '<span class="dm-user-meta">ç®¡ç†è€…</span>';
                                        }
                                        
                                        return '<li>' +
                                            '<a href="/chat/dm/' + user.userId + '" class="dm-user-link">' +
                                            '<div class="dm-user-primary">' +
                                            '<span class="dm-user-name">' + escapeHtml(userName) + '</span>' +
                                            roleBadge +
                                            '</div>' +
                                            '<span class="dm-user-chevron">â€º</span>' +
                                            '</a>' +
                                            '</li>';
                                    }).join('') +
                                    '</ul>';
                                emptyStateCard.appendChild(newSection);
                            }
                        }
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆ
                        if (userSection) {
                            userSection.style.display = 'none';
                        }
                        if (emptyFeedback) {
                            emptyFeedback.style.display = 'block';
                        }
                    }
                })
                .catch(err => {
                    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆå›æ›´æ–°ã€ãã®å¾Œ30ç§’ã”ã¨ã«æ›´æ–°
        window.addEventListener('load', function() {
            // åˆå›ã¯å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰æ›´æ–°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒ¼ã‚¿ãŒç¢ºå®Ÿã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
            setTimeout(refreshUserList, 1000);
            // 30ç§’ã”ã¨ã«æ›´æ–°
            setInterval(refreshUserList, 30000);
        });
    </script>
</body>
</html>

