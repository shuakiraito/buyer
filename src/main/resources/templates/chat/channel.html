<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="'#' + ${channel.channelName} + ' - YAMABIKO'">ãƒãƒ£ãƒƒãƒˆ - YAMABIKO</title>
    <link rel="icon" th:href="@{/img/common/favicon.ico}" href="../static/img/common/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/style.css}" href="../static/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="chat-page">
    <div class="slack-container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="slack-sidebar">
            <div class="slack-sidebar-header">
                <div class="slack-workspace-icon">Y</div>
                <div class="slack-workspace-name">YAMABIKO</div>
            </div>
            <div class="slack-sidebar-nav">
                <a href="#" th:href="@{/chat}" class="slack-nav-item">
                    <span class="slack-nav-icon">ğŸ </span>
                    <span>ãƒ›ãƒ¼ãƒ </span>
                </a>
                <a href="#" th:href="@{/chat/dm}" class="slack-nav-item">
                    <span class="slack-nav-icon">ğŸ’¬</span>
                    <span>DM</span>
                </a>
                <a href="#" th:href="@{/chat/activity}" class="slack-nav-item">
                    <span class="slack-nav-icon">ğŸ””</span>
                    <span>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</span>
                </a>
                
                <div class="slack-section">
                    <div class="slack-section-header" id="channelSectionHeader" style="cursor: pointer;">â–¼ ãƒãƒ£ãƒ³ãƒãƒ«</div>
                    <ul class="slack-channel-list" id="channelList">
                        <li th:each="ch : ${channels}" 
                            class="slack-channel-item" 
                            th:classappend="${ch.id == channel.id} ? 'active'">
                            <a th:href="@{/chat/channel/{id}(id=${ch.id})}">
                                <span class="slack-channel-hash">#</span>
                                <span th:text="${ch.channelName}">ãƒãƒ£ãƒ³ãƒãƒ«å</span>
                            </a>
                        </li>
                        <li class="slack-channel-item" style="padding: 4px 8px;">
                            <button type="button" id="addChannelButton" class="slack-add-channel-btn" style="background: none; border: none; color: var(--slack-text-secondary); cursor: pointer; font-size: 14px; padding: 4px 0; width: 100%; text-align: left;">
                                <span style="margin-right: 4px;">+</span>ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¿½åŠ ã™ã‚‹
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="slack-create-channel" id="createChannelForm" style="display: none;">
                <div class="slack-create-channel-form">
                    <form method="post" th:action="@{/chat/channel/create}">
                        <input type="text" name="channelName" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«å" required />
                        <textarea name="description" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰" rows="2"></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="submit" style="flex: 1;">ä½œæˆ</button>
                            <button type="button" id="cancelChannelButton" style="flex: 1; background-color: var(--slack-border); color: var(--slack-text-primary); border: none; border-radius: 4px; padding: 8px 16px; font-size: 14px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="slack-main">
            <!-- ä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="slack-top-header">
                <div class="slack-header-left">
                    <div class="slack-header-channel-name">
                        <span class="slack-header-channel-hash">#</span>
                        <span th:text="${channel.channelName}">ãƒãƒ£ãƒ³ãƒãƒ«å</span>
                    </div>
                    <div class="channel-search-inline" id="channelSearchInline">
                        <form id="channelSearchForm">
                            <input
                                id="channelSearchInput"
                                class="channel-search-input"
                                type="text"
                                name="keyword"
                                placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢"
                                autocomplete="off"
                            />
                        </form>
                    </div>
                </div>
                <div class="slack-header-actions">
                    <button class="slack-header-button" id="searchButton" title="æ¤œç´¢" th:attr="data-channel-id=${channel.id}">ğŸ”</button>
                    <button class="slack-header-button" id="starButton" title="ã‚¹ã‚¿ãƒ¼" th:attr="data-channel-id=${channel.id}">â­</button>
                    <button class="slack-header-button" id="addMemberButton" title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ " th:attr="data-channel-id=${channel.id}">ğŸ‘¥</button>
                    <button class="slack-header-button" id="channelSettingsButton" title="ãã®ä»–" th:attr="data-channel-id=${channel.id}">â‹¯</button>
                </div>
            </div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div class="slack-messages" id="messages">
                <div th:each="message : ${messages}" class="slack-message" th:attr="data-message-id=${message.id}">
                    <div class="slack-message-avatar" th:text="${message.userName != null ? message.userName.substring(0, 1).toUpperCase() : '?'}">U</div>
                    <div class="slack-message-content">
                        <div class="slack-message-header">
                            <span class="slack-message-author" th:text="${message.userName}">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                            <span class="slack-message-time" th:text="${#temporals.format(message.createdAt, 'yyyyå¹´Mæœˆdæ—¥ H:mm')}">æ™‚åˆ»</span>
                            <span th:if="${message.isEdited}" class="slack-message-edited">(ç·¨é›†æ¸ˆã¿)</span>
                        </div>
                        <div class="slack-message-text" th:text="${message.messageText}">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                        <div class="slack-message-files" th:attr="data-message-id=${message.id}">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                        </div>
                        <div class="slack-message-actions">
                            <button class="slack-message-action-btn btn-edit" th:attr="data-message-id=${message.id}" th:if="${message.userId == userId}">ç·¨é›†</button>
                            <button class="slack-message-action-btn btn-delete" th:attr="data-message-id=${message.id}" th:if="${message.userId == userId}">å‰Šé™¤</button>
                            <button class="slack-message-action-btn btn-unread" th:attr="data-message-id=${message.id}" th:if="${userRole == 'ROLE_TEACHER' || userRole == 'ROLE_ADMIN'}">æœªèª­è€…</button>
                            <button class="slack-message-action-btn btn-remind" th:attr="data-message-id=${message.id}" th:if="${userRole == 'ROLE_TEACHER' || userRole == 'ROLE_ADMIN'}">ãƒªãƒã‚¤ãƒ³ãƒ‰</button>
                            <button class="slack-message-action-btn btn-thread" th:attr="data-message-id=${message.id}">ã‚¹ãƒ¬ãƒƒãƒ‰</button>
                        </div>
                        <div class="slack-message-reactions" th:attr="data-message-id=${message.id}">
                            <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                        </div>
                        <div class="slack-message-threads" th:attr="data-message-id=${message.id}">
                            <div class="slack-thread-list thread-list" th:attr="data-message-id=${message.id}"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="slack-input-container">
                <div class="slack-input-toolbar">
                    <button class="slack-toolbar-btn" title="å¤ªå­—">B</button>
                    <button class="slack-toolbar-btn" title="æ–œä½“">I</button>
                    <button class="slack-toolbar-btn" title="ä¸‹ç·š">U</button>
                    <button class="slack-toolbar-btn" title="å–ã‚Šæ¶ˆã—ç·š">S</button>
                    <button class="slack-toolbar-btn" title="ãƒªãƒ³ã‚¯">ğŸ”—</button>
                    <button class="slack-toolbar-btn" title="ãƒªã‚¹ãƒˆ">â€¢</button>
                    <button class="slack-toolbar-btn" title="å¼•ç”¨">â</button>
                    <button class="slack-toolbar-btn" title="ã‚³ãƒ¼ãƒ‰">&lt;/&gt;</button>
                </div>
                <div class="slack-input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="slack-message-input" 
                        placeholder="'#' + ${channel.channelName} + ' ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'" 
                        rows="1"></textarea>
                    <div class="slack-input-actions">
                        <button class="slack-input-action-btn" id="emojiButton" title="çµµæ–‡å­—">ğŸ˜Š</button>
                        <button class="slack-input-action-btn" id="mentionButton" title="ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³">@</button>
                        <input type="file" id="fileInput" style="display: none;" multiple />
                        <button class="slack-input-action-btn" id="fileButton" title="ãƒ•ã‚¡ã‚¤ãƒ«">ğŸ“</button>
                        <button class="slack-send-btn" id="sendButton" type="button">é€ä¿¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const channelId = /*[[${channel.id}]]*/ 0;
        const userId = /*[[${userId}]]*/ '';
        const userName = /*[[${userName}]]*/ '';
        const userRole = /*[[${userRole}]]*/ 'ROLE_STUDENT';
        const channelName = /*[[${channel.channelName}]]*/ '';
        
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        
        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¨­å®š
        messageInput.placeholder = '#' + channelName + ' ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
        
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            
            const channelTopic = '/topic/channel.' + channelId;
            const threadTopic = '/topic/channel.' + channelId + '.threads';

            stompClient.subscribe(channelTopic, function(message) {
                const data = JSON.parse(message.body);
                handleIncomingMessage(data);
            });

            stompClient.subscribe(threadTopic, function(message) {
                const data = JSON.parse(message.body);
                handleThreadEvent(data);
            });
        });

        function handleIncomingMessage(data) {
            const eventType = (data.eventType || 'NEW').toUpperCase();
            if (eventType === 'UPDATE') {
                updateMessageFromEvent(data);
            } else if (eventType === 'DELETE') {
                markMessageAsDeleted(data.id);
            } else {
                addMessageToUI(data);
            }
        }

        function handleThreadEvent(data) {
            if (!data) {
                return;
            }
            const eventChannelId = data.channelId != null ? Number(data.channelId) : null;
            if (eventChannelId !== null && eventChannelId !== channelId) {
                return;
            }

            const messageId = data.messageId != null ? String(data.messageId) : null;
            if (!messageId) {
                return;
            }

            const threadList = document.querySelector('.thread-list[data-message-id="' + messageId + '"]');
            if (!threadList) {
                return;
            }

            loadThreads(messageId);
        }
        
        function addMessageToUI(data) {
            if (!data) {
                return;
            }
            if (data.deleted && data.id) {
                markMessageAsDeleted(data.id);
                return;
            }

            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const messageId = data.id != null ? String(data.id) : '';
            messageDiv.className = 'slack-message';
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }

            const createdAt = parseDate(data.createdAt);
            const timeStr = formatDateTime(createdAt);
            const displayName = data.userName || data.userId || '?';
            const avatarText = displayName.substring(0, 1).toUpperCase();
            const safeMessage = data.messageText ? escapeHtml(data.messageText) : '';

            let actionsHtml = '';
            if (data.userId === userId) {
                actionsHtml = '<button class="slack-message-action-btn btn-edit" data-message-id="' + messageId + '">ç·¨é›†</button>' +
                    '<button class="slack-message-action-btn btn-delete" data-message-id="' + messageId + '">å‰Šé™¤</button>';
            }
            if (userRole === 'ROLE_TEACHER' || userRole === 'ROLE_ADMIN') {
                actionsHtml += '<button class="slack-message-action-btn btn-unread" data-message-id="' + messageId + '">æœªèª­è€…</button>' +
                    '<button class="slack-message-action-btn btn-remind" data-message-id="' + messageId + '">ãƒªãƒã‚¤ãƒ³ãƒ‰</button>';
            }
            actionsHtml += '<button class="slack-message-action-btn btn-thread" data-message-id="' + messageId + '">ã‚¹ãƒ¬ãƒƒãƒ‰</button>';

            messageDiv.innerHTML =
                '<div class="slack-message-avatar">' + escapeHtml(avatarText) + '</div>' +
                '<div class="slack-message-content">' +
                '<div class="slack-message-header">' +
                '<span class="slack-message-author">' + escapeHtml(displayName) + '</span>' +
                '<span class="slack-message-time">' + timeStr + '</span>' +
                (data.edited ? '<span class="slack-message-edited">(ç·¨é›†æ¸ˆã¿)</span>' : '') +
                '</div>' +
                '<div class="slack-message-text">' + safeMessage + '</div>' +
                '<div class="slack-message-files" data-message-id="' + messageId + '"></div>' +
                '<div class="slack-message-actions">' + actionsHtml + '</div>' +
                '<div class="slack-message-reactions" data-message-id="' + messageId + '"></div>' +
                '<div class="slack-message-threads" data-message-id="' + messageId + '">' +
                '<div class="slack-thread-list thread-list" data-message-id="' + messageId + '"></div>' +
                '</div>' +
                '</div>';

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            attachMessageEventListeners(messageDiv);

            if (messageId) {
                loadMessageFiles(messageId);
                markMessageAsRead(messageId);
            }
        }
        
        function parseDate(value) {
            if (!value) {
                return new Date();
            }
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? new Date() : parsed;
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return year + 'å¹´' + month + 'æœˆ' + day + 'æ—¥ ' + hours + ':' + minutes;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function attachMessageEventListeners(messageDiv) {
            const editBtn = messageDiv.querySelector('.btn-edit');
            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    editMessage(messageId);
                });
            }
            
            const deleteBtn = messageDiv.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    deleteMessage(messageId);
                });
            }
            
            const unreadBtn = messageDiv.querySelector('.btn-unread');
            if (unreadBtn) {
                unreadBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    showUnreadUsers(messageId);
                });
            }
            
            const remindBtn = messageDiv.querySelector('.btn-remind');
            if (remindBtn) {
                remindBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    sendReminder(messageId);
                });
            }
            
            const threadBtn = messageDiv.querySelector('.btn-thread');
            if (threadBtn) {
                threadBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    showThreadInput(messageId);
                });
            }
            
            const reactionsDiv = messageDiv.querySelector('.slack-message-reactions');
            if (reactionsDiv) {
                reactionsDiv.addEventListener('click', function(e) {
                    const pill = e.target.closest('.reaction-pill');
                    if (pill) {
                        const messageId = reactionsDiv.getAttribute('data-message-id');
                        const emoji = pill.getAttribute('data-emoji');
                        const isActive = pill.getAttribute('data-reacted') === 'true';
                        if (messageId && emoji) {
                            toggleReaction(messageId, null, emoji, isActive);
                        }
                        return;
                    }

                    const trigger = e.target.closest('.reaction-trigger');
                    if (trigger) {
                        const messageId = reactionsDiv.getAttribute('data-message-id');
                        if (messageId) {
                            showReactionPicker(trigger, messageId);
                        }
                    }
                });
                loadReactions(reactionsDiv.getAttribute('data-message-id'));
            }
        }

        function updateMessageFromEvent(data) {
            if (!data || data.id == null) {
                return;
            }
            updateMessageInUI(String(data.id), data.messageText || '', {
                edited: data.edited,
                updatedAt: data.updatedAt
            });
        }

        function updateMessageInUI(messageId, messageText, options = {}) {
            if (!messageId) {
                return;
            }
            const messageDiv = document.querySelector('.slack-message[data-message-id="' + messageId + '"]');
            if (!messageDiv) {
                return;
            }

            const messageTextDiv = messageDiv.querySelector('.slack-message-text');
            if (messageTextDiv) {
                messageTextDiv.textContent = messageText;
                messageTextDiv.classList.remove('slack-message-text-deleted');
                messageTextDiv.style.removeProperty('font-style');
                messageTextDiv.style.removeProperty('color');
            }

            const header = messageDiv.querySelector('.slack-message-header');
            if (header) {
                const edited = options.edited !== undefined ? options.edited : true;
                let editedSpan = header.querySelector('.slack-message-edited');
                if (edited) {
                    if (!editedSpan) {
                        editedSpan = document.createElement('span');
                        editedSpan.className = 'slack-message-edited';
                        editedSpan.textContent = '(ç·¨é›†æ¸ˆã¿)';
                        header.appendChild(editedSpan);
                    } else {
                        editedSpan.textContent = '(ç·¨é›†æ¸ˆã¿)';
                    }
                } else if (editedSpan) {
                    editedSpan.remove();
                }

                if (options.updatedAt) {
                    const timeSpan = header.querySelector('.slack-message-time');
                    if (timeSpan) {
                        timeSpan.textContent = formatDateTime(parseDate(options.updatedAt));
                    }
                }
            }

            const actions = messageDiv.querySelectorAll('.slack-message-actions button');
            actions.forEach(btn => {
                btn.disabled = false;
            });

            messageDiv.classList.remove('slack-message-deleted');
            messageDiv.style.removeProperty('opacity');
        }

        function markMessageAsDeleted(messageId) {
            if (!messageId) {
                return;
            }
            const messageDiv = document.querySelector('.slack-message[data-message-id="' + messageId + '"]');
            if (!messageDiv) {
                return;
            }

            const messageTextDiv = messageDiv.querySelector('.slack-message-text');
            if (messageTextDiv) {
                messageTextDiv.textContent = 'ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ';
                messageTextDiv.classList.add('slack-message-text-deleted');
                messageTextDiv.style.fontStyle = 'italic';
                messageTextDiv.style.color = 'var(--slack-text-secondary, #888)';
            }

            const actions = messageDiv.querySelectorAll('.slack-message-actions button');
            actions.forEach(btn => {
                btn.disabled = true;
            });

            messageDiv.classList.add('slack-message-deleted');
            messageDiv.style.opacity = '0.6';
        }
        
        function editMessage(messageId) {
            const messageDiv = document.querySelector('[data-message-id="' + messageId + '"]');
            const messageTextDiv = messageDiv.querySelector('.slack-message-text');
            const currentText = messageTextDiv.textContent;
            
            const input = document.createElement('textarea');
            input.value = currentText;
            input.className = 'slack-message-input';
            input.style.width = '100%';
            input.style.minHeight = '60px';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.className = 'slack-send-btn';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelBtn.className = 'slack-message-action-btn';
            
            messageTextDiv.innerHTML = '';
            messageTextDiv.appendChild(input);
            messageTextDiv.appendChild(saveBtn);
            messageTextDiv.appendChild(cancelBtn);
            
            saveBtn.addEventListener('click', function() {
                const newText = input.value.trim();
                if (newText) {
                    updateMessage(messageId, newText);
                }
            });
            
            cancelBtn.addEventListener('click', function() {
                messageTextDiv.textContent = currentText;
            });
        }
        
        function updateMessage(messageId, messageText) {
            const formData = new FormData();
            formData.append('messageId', messageId);
            formData.append('messageText', messageText);
            
            fetch('/chat/message/update', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    updateMessageInUI(messageId, messageText, { edited: true });
                } else {
                    response.text().then(text => {
                        alert(text || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        function deleteMessage(messageId) {
            if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('messageId', messageId);
            
            fetch('/chat/message/delete', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    markMessageAsDeleted(messageId);
                } else {
                    response.text().then(text => {
                        alert(text || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        function showUnreadUsers(messageId) {
            fetch('/chat/message/' + messageId + '/unread')
                .then(response => response.json())
                .then(data => {
                    const userList = data.map(u => u.userName || u.userId).join(', ');
                    alert('æœªèª­è€…: ' + (userList || 'ãªã—'));
                });
        }
        
        function sendReminder(messageId) {
            if (!confirm('æœªèª­è€…ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            fetch('/chat/message/' + messageId + '/remind', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
            });
        }
        
        function showThreadInput(messageId) {
            const threadList = document.querySelector('.thread-list[data-message-id="' + messageId + '"]');
            if (!threadList) return;
            
            const existingInput = threadList.querySelector('.thread-input-wrapper');
            if (existingInput) {
                existingInput.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'thread-input-wrapper';

            const input = document.createElement('textarea');
            input.placeholder = 'ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¿”ä¿¡...';
            input.className = 'slack-message-input';
            input.style.width = '100%';
            input.style.minHeight = '60px';
            
            const actionBar = document.createElement('div');
            actionBar.style.marginTop = '8px';
            actionBar.style.display = 'flex';
            actionBar.style.gap = '8px';

            const sendBtn = document.createElement('button');
            sendBtn.textContent = 'é€ä¿¡';
            sendBtn.className = 'slack-send-btn';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelBtn.className = 'slack-message-action-btn';

            actionBar.appendChild(sendBtn);
            actionBar.appendChild(cancelBtn);

            wrapper.appendChild(input);
            wrapper.appendChild(actionBar);

            threadList.appendChild(wrapper);

            sendBtn.addEventListener('click', function() {
                const threadText = input.value.trim();
                if (threadText) {
                    createThread(messageId, threadText);
                }
            });

            cancelBtn.addEventListener('click', function() {
                wrapper.remove();
            });
        }
        
        function createThread(messageId, threadText) {
            const formData = new FormData();
            formData.append('messageId', messageId);
            formData.append('threadText', threadText);
            
            fetch('/chat/thread/create', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    loadThreads(messageId);
                } else {
                    response.text().then(text => {
                        alert(text || 'ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        function loadThreads(messageId) {
            fetch('/chat/thread/' + messageId)
                .then(response => response.json())
                .then(threads => {
                    const threadList = document.querySelector('.thread-list[data-message-id="' + messageId + '"]');
                    if (threadList) {
                        threadList.innerHTML = threads.map(t => {
                            const author = escapeHtml(t.userName || t.userId);
                            const text = escapeHtml(t.threadText || '');
                            const editedLabel = t.isEdited ? '<span class="slack-thread-edited">(ç·¨é›†æ¸ˆã¿)</span>' : '';
                            const timeLabel = t.createdAt ? '<span class="slack-thread-time">' + formatDateTime(parseDate(t.createdAt)) + '</span>' : '';
                            const canEdit = t.userId === userId;
                            const actions = canEdit
                                ? '<div class="slack-thread-actions">' +
                                    '<button class="slack-message-action-btn btn-thread-edit" data-thread-id="' + t.id + '" data-message-id="' + t.messageId + '">ç·¨é›†</button>' +
                                    '<button class="slack-message-action-btn btn-thread-delete" data-thread-id="' + t.id + '" data-message-id="' + t.messageId + '">å‰Šé™¤</button>' +
                                  '</div>'
                                : '';
                            return '<div class="slack-thread-item" data-thread-id="' + t.id + '" data-message-id="' + t.messageId + '">' +
                                '<div class="slack-thread-header">' +
                                    '<span class="slack-thread-author">' + author + '</span>' +
                                    timeLabel +
                                    editedLabel +
                                '</div>' +
                                '<div class="slack-thread-text">' + text + '</div>' +
                                actions +
                            '</div>';
                        }).join('');

                        attachThreadEventListeners(threadList);
                    }
                })
                .catch(() => {
                    // ignore load errors temporarily
                });
        }

        function attachThreadEventListeners(threadList) {
            threadList.querySelectorAll('.btn-thread-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const threadId = this.getAttribute('data-thread-id');
                    editThread(threadId);
                });
            });

            threadList.querySelectorAll('.btn-thread-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const threadId = this.getAttribute('data-thread-id');
                    deleteThread(threadId);
                });
            });
        }

        function editThread(threadId) {
            const threadItem = document.querySelector('.slack-thread-item[data-thread-id="' + threadId + '"]');
            if (!threadItem) return;

            const textDiv = threadItem.querySelector('.slack-thread-text');
            if (!textDiv || textDiv.querySelector('textarea')) {
                return;
            }

            const originalText = textDiv.textContent;
            const textarea = document.createElement('textarea');
            textarea.className = 'slack-message-input';
            textarea.style.width = '100%';
            textarea.style.minHeight = '60px';
            textarea.value = originalText;

            const actionBar = document.createElement('div');
            actionBar.style.marginTop = '8px';
            actionBar.style.display = 'flex';
            actionBar.style.gap = '8px';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.className = 'slack-send-btn';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelBtn.className = 'slack-message-action-btn';

            textDiv.innerHTML = '';
            textDiv.appendChild(textarea);
            actionBar.appendChild(saveBtn);
            actionBar.appendChild(cancelBtn);
            textDiv.appendChild(actionBar);

            saveBtn.addEventListener('click', function() {
                const newText = textarea.value.trim();
                if (newText) {
                    updateThreadRequest(threadId, newText);
                }
            });

            cancelBtn.addEventListener('click', function() {
                textDiv.textContent = originalText;
            });
        }

        function updateThreadRequest(threadId, threadText) {
            const threadItem = document.querySelector('.slack-thread-item[data-thread-id="' + threadId + '"]');
            if (!threadItem) return;
            const messageId = threadItem.getAttribute('data-message-id');

            const formData = new FormData();
            formData.append('threadId', threadId);
            formData.append('threadText', threadText);

            fetch('/chat/thread/update', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok && messageId) {
                    loadThreads(messageId);
                } else if (!response.ok) {
                    response.text().then(text => {
                        alert(text || 'ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        function deleteThread(threadId) {
            if (!confirm('ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const threadItem = document.querySelector('.slack-thread-item[data-thread-id="' + threadId + '"]');
            if (!threadItem) return;
            const messageId = threadItem.getAttribute('data-message-id');

            const formData = new FormData();
            formData.append('threadId', threadId);

            fetch('/chat/thread/delete', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok && messageId) {
                    loadThreads(messageId);
                } else if (!response.ok) {
                    response.text().then(text => {
                        alert(text || 'ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                alert('ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        function toggleReaction(messageId, threadId, emoji, remove = false) {
            const reactionsDiv = document.querySelector('.slack-message-reactions[data-message-id="' + messageId + '"]');
            if (!reactionsDiv) return;
            
            const formData = new FormData();
            if (messageId) formData.append('messageId', messageId);
            if (threadId) formData.append('threadId', threadId);
            formData.append('emoji', emoji);
            
            fetch(remove ? '/chat/reaction/remove' : '/chat/reaction/add', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    loadReactions(messageId);
                } else {
                    response.text().then(text => {
                        console.error(text || 'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
            }).catch(() => {
                console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        function loadReactions(messageId) {
            if (!messageId) return;
            
            fetch('/chat/message/' + messageId + '/reactions')
                .then(response => response.json())
                .then(reactions => {
                    const reactionsDiv = document.querySelector('.slack-message-reactions[data-message-id="' + messageId + '"]');
                    if (reactionsDiv) {
                        const grouped = {};
                        reactions.forEach(r => {
                            if (!grouped[r.emoji]) {
                                grouped[r.emoji] = { count: 0, reacted: false };
                            }
                            grouped[r.emoji].count += 1;
                            if (r.userId === userId) {
                                grouped[r.emoji].reacted = true;
                            }
                        });
                        
                        const triggerButton = '<button type="button" class="reaction-trigger" title="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ">ğŸ˜Š</button>';
                        const pills = Object.entries(grouped).map(([emoji, meta]) =>
                            '<button type="button" class="reaction-pill' + (meta.reacted ? ' active' : '') + '" data-emoji="' + emoji + '" data-reacted="' + meta.reacted + '">' +
                                '<span class="reaction-pill-emoji">' + emoji + '</span>' +
                                '<span class="reaction-pill-count">' + meta.count + '</span>' +
                            '</button>'
                        ).join('');
                        
                        reactionsDiv.innerHTML = triggerButton + pills;
                    }
                });
        }
        
        function markMessageAsRead(messageId) {
            fetch('/chat/message/' + messageId + '/read', {
                method: 'POST'
            });
        }
        
        function loadMessageFiles(messageId) {
            if (!messageId) return;
            
            fetch('/chat/message/' + messageId + '/files')
                .then(response => response.json())
                .then(files => {
                    const filesDiv = document.querySelector('.slack-message-files[data-message-id="' + messageId + '"]');
                    if (filesDiv && files.length > 0) {
                        filesDiv.innerHTML = files.map(f => 
                            '<div style="margin-top: 8px; padding: 8px; background-color: var(--pale-gray-color); border-radius: 4px;">' +
                            'ğŸ“ <a href="' + f.filePath + '" target="_blank" style="color: var(--slack-accent);">' + 
                            escapeHtml(f.fileName) + '</a> (' + formatFileSize(f.fileSize) + ')' +
                            '</div>'
                        ).join('');
                    }
                })
                .catch(() => {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç„¡è¦–
                });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        document.getElementById('sendButton').addEventListener('click', function() {
            sendMessage();
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // sendMessageé–¢æ•°ã¯ä¸Šã§å®šç¾©æ¸ˆã¿
        
        // ãƒãƒ£ãƒ³ãƒãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹
        document.getElementById('channelSectionHeader').addEventListener('click', function() {
            const channelList = document.getElementById('channelList');
            const isHidden = channelList.style.display === 'none';
            channelList.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden ? 'â–¼ ãƒãƒ£ãƒ³ãƒãƒ«' : 'â–¶ ãƒãƒ£ãƒ³ãƒãƒ«';
        });
        
        // ãƒãƒ£ãƒ³ãƒãƒ«è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        const addChannelButton = document.getElementById('addChannelButton');
        if (addChannelButton) {
            addChannelButton.addEventListener('click', function() {
                const form = document.getElementById('createChannelForm');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                if (form.style.display === 'block') {
                    const input = form.querySelector('input[name="channelName"]');
                    if (input) {
                        input.focus();
                    }
                }
            });
        }
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        const cancelChannelButton = document.getElementById('cancelChannelButton');
        if (cancelChannelButton) {
            cancelChannelButton.addEventListener('click', function() {
                document.getElementById('createChannelForm').style.display = 'none';
                const form = document.querySelector('.slack-create-channel-form form');
                if (form) {
                    form.reset();
                }
            });
        }

        // ãƒãƒ£ãƒ³ãƒãƒ«ã‚¹ã‚¿ãƒ¼æ©Ÿèƒ½
        document.getElementById('starButton').addEventListener('click', function() {
            const channelId = this.getAttribute('data-channel-id');
            fetch('/chat/channel/' + channelId + '/star', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    // ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
                    this.style.opacity = this.style.opacity === '0.5' ? '1' : '0.5';
                }
            });
        });

        // ãƒãƒ£ãƒ³ãƒãƒ«æ¤œç´¢
        document.getElementById('searchButton').addEventListener('click', function() {
            const channelId = this.getAttribute('data-channel-id');
            const searchInline = document.getElementById('channelSearchInline');
            const searchInput = document.getElementById('channelSearchInput');
            searchInline.classList.toggle('is-active');
            if (searchInline.classList.contains('is-active')) {
                searchInput.focus();
                searchInput.setSelectionRange(0, searchInput.value.length);
            }
        });

        const channelSearchForm = document.getElementById('channelSearchForm');
        channelSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const channelId = document.getElementById('searchButton').getAttribute('data-channel-id');
            const keyword = document.getElementById('channelSearchInput').value.trim();
            const params = new URLSearchParams();
            if (keyword) {
                params.append('keyword', keyword);
            }
            if (channelId) {
                params.append('channelId', channelId);
            }
            window.location.href = '/chat/search?' + params.toString();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const searchInline = document.getElementById('channelSearchInline');
                if (searchInline.classList.contains('is-active')) {
                    searchInline.classList.remove('is-active');
                }
            }
        });

        document.addEventListener('click', function(e) {
            const searchInline = document.getElementById('channelSearchInline');
            const searchButton = document.getElementById('searchButton');
            if (!searchInline.contains(e.target) && e.target !== searchButton && !searchButton.contains(e.target)) {
                searchInline.classList.remove('is-active');
            }
        });

        // ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
        document.getElementById('addMemberButton').addEventListener('click', function() {
            const channelId = this.getAttribute('data-channel-id');
            showAddMemberDialog(channelId);
        });

        function showAddMemberDialog(channelId) {
            fetch('/chat/users')
                .then(response => response.json())
                .then(users => {
                    const userList = users.map(u => 
                        '<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid var(--slack-border);" onclick="addMemberToChannel(' + channelId + ', \'' + u.userId() + '\')">' +
                        escapeHtml(u.userName() || u.userId()) +
                        '</div>'
                    ).join('');
                    
                    const dialog = document.createElement('div');
                    dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--slack-sidebar-bg); padding: 20px; border-radius: 8px; z-index: 1000; max-width: 400px; max-height: 500px; overflow-y: auto;';
                    dialog.innerHTML = 
                        '<h3 style="margin-top: 0; color: var(--slack-text-primary);">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </h3>' +
                        '<div>' + userList + '</div>' +
                        '<button onclick="this.parentElement.remove()" style="margin-top: 16px; width: 100%;" class="slack-send-btn">é–‰ã˜ã‚‹</button>';
                    document.body.appendChild(dialog);
                });
        }

        function addMemberToChannel(channelId, memberUserId) {
            const formData = new FormData();
            formData.append('userId', memberUserId);
            
            fetch('/chat/channel/' + channelId + '/add-member', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    location.reload();
                }
            });
        }

        // ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š
        document.getElementById('channelSettingsButton').addEventListener('click', function() {
            const channelId = this.getAttribute('data-channel-id');
            showChannelSettings(channelId);
        });

        function showChannelSettings(channelId) {
            const description = prompt('ãƒãƒ£ãƒ³ãƒãƒ«ã®èª¬æ˜ã‚’ç·¨é›†:', '');
            if (description !== null) {
                const formData = new FormData();
                formData.append('description', description);
                
                fetch('/chat/channel/' + channelId + '/update', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        alert('ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        location.reload();
                    }
                });
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼
        document.querySelectorAll('.slack-toolbar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const title = this.getAttribute('title');
                const messageInput = document.getElementById('messageInput');
                const start = messageInput.selectionStart;
                const end = messageInput.selectionEnd;
                const selectedText = messageInput.value.substring(start, end);
                let replacement = '';
                
                switch(title) {
                    case 'å¤ªå­—':
                        replacement = '**' + (selectedText || 'å¤ªå­—') + '**';
                        break;
                    case 'æ–œä½“':
                        replacement = '*' + (selectedText || 'æ–œä½“') + '*';
                        break;
                    case 'ä¸‹ç·š':
                        replacement = '<u>' + (selectedText || 'ä¸‹ç·š') + '</u>';
                        break;
                    case 'å–ã‚Šæ¶ˆã—ç·š':
                        replacement = '~~' + (selectedText || 'å–ã‚Šæ¶ˆã—ç·š') + '~~';
                        break;
                    case 'ãƒªãƒ³ã‚¯':
                        replacement = '[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)';
                        break;
                    case 'ãƒªã‚¹ãƒˆ':
                        replacement = '- ' + (selectedText || 'ãƒªã‚¹ãƒˆé …ç›®');
                        break;
                    case 'å¼•ç”¨':
                        replacement = '> ' + (selectedText || 'å¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆ');
                        break;
                    case 'ã‚³ãƒ¼ãƒ‰':
                        replacement = '`' + (selectedText || 'ã‚³ãƒ¼ãƒ‰') + '`';
                        break;
                }
                
                messageInput.value = messageInput.value.substring(0, start) + replacement + messageInput.value.substring(end);
                messageInput.focus();
                messageInput.setSelectionRange(start + replacement.length, start + replacement.length);
            });
        });

        // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼
        const emojiList = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'];
        
        document.getElementById('emojiButton').addEventListener('click', function() {
            showEmojiPicker(messageInput);
        });

        function showEmojiPicker(inputElement) {
            const picker = document.createElement('div');
            picker.style.cssText = 'position: absolute; background: var(--slack-sidebar-bg); border: 1px solid var(--slack-border); border-radius: 8px; padding: 12px; z-index: 1000; max-width: 300px; max-height: 300px; overflow-y: auto; display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;';
            
            emojiList.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.textContent = emoji;
                emojiBtn.style.cssText = 'background: none; border: none; font-size: 24px; cursor: pointer; padding: 4px;';
                emojiBtn.addEventListener('click', function() {
                    const start = inputElement.selectionStart;
                    inputElement.value = inputElement.value.substring(0, start) + emoji + inputElement.value.substring(start);
                    inputElement.focus();
                    inputElement.setSelectionRange(start + emoji.length, start + emoji.length);
                    picker.remove();
                });
                picker.appendChild(emojiBtn);
            });
            
            const rect = inputElement.getBoundingClientRect();
            picker.style.top = (rect.top - 320) + 'px';
            picker.style.left = rect.left + 'px';
            document.body.appendChild(picker);
            
            setTimeout(() => {
                document.addEventListener('click', function closePicker(e) {
                    if (!picker.contains(e.target) && e.target !== inputElement) {
                        picker.remove();
                        document.removeEventListener('click', closePicker);
                    }
                });
            }, 100);
        }

        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        document.getElementById('mentionButton').addEventListener('click', function() {
            showMentionPicker(messageInput);
        });

        function showMentionPicker(inputElement) {
            fetch('/chat/users')
                .then(response => response.json())
                .then(users => {
                    const picker = document.createElement('div');
                    picker.style.cssText = 'position: absolute; background: var(--slack-sidebar-bg); border: 1px solid var(--slack-border); border-radius: 8px; padding: 8px; z-index: 1000; max-width: 300px; max-height: 300px; overflow-y: auto;';
                    
                    users.forEach(user => {
                        const userBtn = document.createElement('div');
                        userBtn.textContent = '@' + (user.userName() || user.userId());
                        userBtn.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid var(--slack-border); color: var(--slack-text-primary);';
                        userBtn.addEventListener('click', function() {
                            const start = inputElement.selectionStart;
                            const mention = '@' + user.userId() + ' ';
                            inputElement.value = inputElement.value.substring(0, start) + mention + inputElement.value.substring(start);
                            inputElement.focus();
                            inputElement.setSelectionRange(start + mention.length, start + mention.length);
                            picker.remove();
                        });
                        picker.appendChild(userBtn);
                    });
                    
                    const rect = inputElement.getBoundingClientRect();
                    picker.style.top = (rect.top - 200) + 'px';
                    picker.style.left = rect.left + 'px';
                    document.body.appendChild(picker);
                    
                    setTimeout(() => {
                        document.addEventListener('click', function closePicker(e) {
                            if (!picker.contains(e.target) && e.target !== inputElement) {
                                picker.remove();
                                document.removeEventListener('click', closePicker);
                            }
                        });
                    }, 100);
                });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('fileButton').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        let pendingFiles = [];
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                pendingFiles = files;
                alert(files.length + 'å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚');
            }
        });
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°ã‚’æ‹¡å¼µ
        const originalSendMessageFunction = function() {
            const messageText = messageInput.value.trim();
            
            if (messageText) {
                const chatMessage = {
                    channelId: channelId,
                    userId: userId,
                    userName: userName,
                    messageText: messageText
                };
                
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¾Œã«æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’å–å¾—ï¼‰
                if (pendingFiles.length > 0) {
                    setTimeout(() => {
                        fetch('/chat/message/latest?channelId=' + channelId)
                            .then(response => response.json())
                            .then(message => {
                                if (message && message.id) {
                                    uploadFiles(message.id, pendingFiles);
                                    pendingFiles = [];
                                    document.getElementById('fileInput').value = '';
                                }
                            })
                            .catch(() => {
                                pendingFiles = [];
                                document.getElementById('fileInput').value = '';
                            });
                    }, 500);
                }
            } else if (pendingFiles.length > 0) {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆãŒãªãã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿é€ä¿¡å¯èƒ½
                const chatMessage = {
                    channelId: channelId,
                    userId: userId,
                    userName: userName,
                    messageText: '[ãƒ•ã‚¡ã‚¤ãƒ«]'
                };
                
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                
                setTimeout(() => {
                    fetch('/chat/message/latest?channelId=' + channelId)
                        .then(response => response.json())
                        .then(message => {
                            if (message && message.id) {
                                uploadFiles(message.id, pendingFiles);
                                pendingFiles = [];
                                document.getElementById('fileInput').value = '';
                            }
                        })
                        .catch(() => {
                            pendingFiles = [];
                            document.getElementById('fileInput').value = '';
                        });
                }, 500);
            }
        };
        
        // å…ƒã®sendMessageé–¢æ•°ã‚’ç½®ãæ›ãˆ
        window.sendMessage = originalSendMessageFunction;
        
        function uploadFiles(messageId, files) {
            files.forEach(file => {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/chat/message/' + messageId + '/file', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                });
            });
        }

        function showReactionPicker(anchorElement, messageId) {
            const picker = document.createElement('div');
            picker.style.cssText = 'position: fixed; background: var(--slack-sidebar-bg); border: 1px solid var(--slack-border); border-radius: 8px; padding: 12px; z-index: 1000; max-width: 300px; max-height: 300px; overflow-y: auto; display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;';
            
            emojiList.slice(0, 32).forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.textContent = emoji;
                emojiBtn.style.cssText = 'background: none; border: none; font-size: 24px; cursor: pointer; padding: 4px;';
                emojiBtn.addEventListener('click', function() {
                    toggleReaction(messageId, null, emoji);
                    picker.remove();
                });
                picker.appendChild(emojiBtn);
            });
            
            const rect = anchorElement.getBoundingClientRect();
            const pickerHeight = 320;
            const topPosition = rect.top - pickerHeight > 0 ? rect.top - pickerHeight : rect.bottom + 8;
            picker.style.top = topPosition + 'px';
            picker.style.left = rect.left + 'px';
            document.body.appendChild(picker);
            
            setTimeout(() => {
                document.addEventListener('click', function closePicker(e) {
                    if (!picker.contains(e.target) && !anchorElement.contains(e.target)) {
                        picker.remove();
                        document.removeEventListener('click', closePicker);
                    }
                });
            }, 100);
        }

        window.addEventListener('load', function() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            document.querySelectorAll('.slack-message').forEach(msg => {
                attachMessageEventListeners(msg);
                const messageId = msg.getAttribute('data-message-id');
                if (messageId) {
                    loadReactions(messageId);
                    loadThreads(messageId);
                    loadMessageFiles(messageId);
                    markMessageAsRead(messageId);
                }
            });
            
            // ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ç¢ºèª
            fetch('/chat/channel/' + channelId + '/star')
                .then(response => response.json())
                .then(isStarred => {
                    const starButton = document.getElementById('starButton');
                    if (isStarred) {
                        starButton.style.opacity = '1';
                    } else {
                        starButton.style.opacity = '0.5';
                    }
                })
                .catch(() => {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç„¡è¦–ï¼ˆã‚¹ã‚¿ãƒ¼çŠ¶æ…‹å–å¾—ã¯å¾Œã§å®Ÿè£…ï¼‰
                });
        });
    </script>
</body>
</html>
